{"version":3,"file":"pages3/community/resource-detail/index.js","mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAeA;;AAEA;AAAA;AAEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AAAA;AAAA;AAGA;AACA;AAGA;AAAA;AACA;AAAA;AAAA;AAuCA;AACA;AACA;AACA;AAAA;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AAAA;AAEA;AACA;AACA;AACA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAKA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA;AACA;AAAA;AAAA;AAAA;AAFA;AAAA;AAAA;AAIA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAIA;AACA;AACA;AACA;AACA;AACA;AALA;AAAA;AAMA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AAGA;AACA;AACA;AACA;AAAA;AAAA;AAKA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AANA;AAAA;AAQA;AAAA;AAEA;AAAA;AAAA;AAAA;AAAA;AAIA;AACA;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAEA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAEA;AAAA;AAAA;AAAA;AAAA;AAIA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAEA;AAAA;AAAA;AAAA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AAEA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAvMA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AAAA;AAEA;AACA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AA/BA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AA2EA;AAAA;AAAA;AACA;AAAA;AAAA;AA8HA;AAAA;AAAA;AAAA;AAEA;AACA;AACA;AACA;AACA;AAAA;AAEA;AACA;AACA;AACA;AACA;AAAA;AAEA;AAAA;AACA;AAAA;AAEA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AAGA;AAAA;AAAA;AAGA;AAAA;AACA;AACA;AAAA;AAEA;AAEA;AAAA;;;;;;;;;;;;;AC9RA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","sources":["webpack://wechat-app-hrbust/._src_pages3_community_resource-detail_index.tsx","webpack://wechat-app-hrbust/./src/pages3/community/resource-detail/index.tsx?4734"],"sourcesContent":["import React, { Component } from 'react'\nimport { connect } from 'react-redux'\nimport { View } from '@tarojs/components'\nimport Taro from '@tarojs/taro'\nimport { IRootState } from '@/types'\nimport { APIS } from '@/services2'\nimport { withRequest, showToast, loginModal, getCdnUrl } from '@/utils'\nimport { routes } from '@/app.config'\nimport { withShare } from '@/components'\nimport ResourceItem from '@/components/resource-item'\nimport './index.less'\nimport { CommentType } from '../_components/comment-input'\nimport CommentList from '../_components/comment-list'\n\ntype PropsFromState = ReturnType<typeof mapStateToProps>\ntype PropsFromDispatch = {}\n\ntype PageOwnProps = {}\n\ntype PageState = {\n  data: GetApiResultType<typeof APIS.ResourceApi.apiResourceIdGet>\n  commentList: GetApiResultType<typeof APIS.CommentApi.apiCommentResourceIdGet>\n  hasNext: boolean\n}\n\ntype IProps = PropsFromState & PropsFromDispatch & PageOwnProps\n\nconst prefix = 'resource-detail'\n\n// @withShare({ title: '分享' })\n\nclass ResourceDetail extends Component<IProps, PageState> {\n  state: PageState = {\n    data: undefined,\n    commentList: [],\n    hasNext: true\n  }\n\n  id: string\n  pageNum = 0\n  pageSize = 20\n  fetching = false\n\n  // 在页面中定义激励视频广告\n  videoAd: any = null\n  loadAdError: boolean\n\n  adCallback?: Function\n\n  async onLoad(e) {\n    await loginModal()\n    if (e.id) {\n      this.id = e.id\n      this.getData()\n      this.getComment()\n    }\n\n    // 在页面onLoad回调事件中创建激励视频广告实例\n    if (wx.createRewardedVideoAd) {\n      this.videoAd = wx.createRewardedVideoAd({\n        adUnitId: 'adunit-3e946876c54cdba5'\n      })\n      this.videoAd.onLoad(() => {\n        console.log('onLoad event emit')\n      })\n      this.videoAd.onError(err => {\n        console.log('onError event emit', err)\n        this.loadAdError = true\n      })\n      this.videoAd.onClose(res => {\n        console.log('onClose event emit', res)\n        // 用户点击了【关闭广告】按钮\n        if (res && res.isEnded) {\n          // 正常播放结束，可以下发游戏奖励\n          this.adCallback?.()\n        } else {\n          // 播放中途退出，不下发游戏奖励\n        }\n      })\n    }\n  }\n\n  _shareOptions = {\n    title: '分享了你一条表白墙',\n    imageUrl: '',\n    path: routes.community\n  }\n\n  onShowAd = (callback: Function) => {\n    this.adCallback = callback\n    if (this.videoAd && !this.loadAdError) {\n      Taro.showModal({\n        title: '是否观看广告',\n        content: '资源共享限时免费，但是资源收集不易，看个广告支持一下吧~',\n        success: res => {\n          if (res.confirm) {\n            // 用户触发广告后，显示激励视频广告\n            this.videoAd.show().catch(() => {\n              // 失败重试\n              this.videoAd\n                .load()\n                .then(() => this.videoAd.show())\n                .catch(err => {\n                  console.log(err)\n                  // 失败重试一次\n                  this.videoAd!.load()\n                    .then(() => this.videoAd.show())\n                    .catch(err => {\n                      console.log(err)\n                      callback()\n                    })\n                })\n            })\n          } else if (res.cancel) {\n            // console.log('用户点击取消')\n          }\n        }\n      })\n      return\n    } else {\n      callback?.()\n    }\n  }\n\n  onShareAppMessage() {}\n  onShareTimeline() {}\n\n  getData = async () => {\n    const [err, res] = await withRequest(APIS.ResourceApi.apiResourceIdGet)({\n      id: this.id\n    })\n\n    if (!err && res) {\n      if (!res._id) {\n        // Taro.navigateBack()\n        showToast({\n          title: '该内容不存在或已被删除',\n          icon: 'none',\n          finished: () => {\n            Taro.navigateBack({\n              fail() {\n                Taro.switchTab({\n                  url: routes.index\n                })\n              }\n            })\n          }\n        })\n        return\n      }\n\n      this.setState({\n        data: res\n      })\n      this._shareOptions = {\n        title: '分享你一个资源:' + res.name,\n        // imageUrl: getCdnUrl(res?.photos?.[0]),\n        imageUrl: '',\n        path: routes.resourceDetail + '?id=' + res._id\n      }\n    }\n  }\n\n  /**\n   *\n   * @param reset 是否重置\n   * @param refresh 是否刷新当前数据\n   * @returns\n   */\n  getComment = async (reset?: boolean, refresh?: boolean) => {\n    this.fetching = true\n    let pageNum = String(this.pageNum)\n    let pageSize = String(this.pageSize)\n\n    // 刷新当前数据\n    if (refresh) {\n      pageNum = '0'\n      pageSize = String((this.pageNum + 1) * this.pageSize)\n    }\n\n    const [err, res] = await withRequest(\n      APIS.CommentApi.apiCommentResourceIdGet\n    )({\n      id: this.id,\n      pageNum,\n      pageSize\n    })\n\n    this.fetching = false\n\n    if (err || !res) {\n      return\n    }\n\n    this.setState({\n      commentList:\n        reset || refresh ? res : (this.state.commentList || []).concat(res),\n      hasNext: res.length >= this.pageSize\n    })\n  }\n\n  // 评论\n  onCommentSubmit = async (value: string, to?: string, commentId?: string) => {\n    const { data } = this.state\n\n    if (!data) {\n      return\n    }\n\n    const params: Parameters<typeof APIS.CommentApi.apiCommentPost>[0] = {\n      resourceId: data._id,\n      content: value,\n      to: data.publisher?._id,\n      type: CommentType.ResourceComment\n    }\n    // 回复评论\n    if (commentId) {\n      params.to = to\n      params.type = CommentType.ReplyComment\n      params.commentId = commentId\n    }\n    const [err] = await withRequest(APIS.CommentApi.apiCommentPost)(params)\n\n    if (err) {\n      return Promise.reject()\n    }\n    Taro.showToast({\n      title: '评论成功',\n      icon: 'success'\n    })\n    this.getComment(false, true)\n    this.getData()\n  }\n\n  onReachBottom = () => {\n    if (!this.state.hasNext || this.fetching) {\n      return\n    }\n    this.pageNum++\n    return this.getComment().catch(() => {\n      this.pageNum--\n    })\n  }\n\n  onPullDownRefresh = async () => {\n    await this.getData()\n    this.getComment(true)\n    Taro.stopPullDownRefresh()\n  }\n\n  render() {\n    const { data, commentList = [] } = this.state\n\n    if (!data) {\n      return null\n    }\n    return (\n      <View className={prefix}>\n        <ResourceItem\n          showDetail\n          data={data}\n          timeType=\"relative\"\n          showDelete\n          onShowAd={this.onShowAd}\n        ></ResourceItem>\n        <View className={`${prefix}__border-line`}></View>\n        <View className={`${prefix}__comment-list`}>\n          <CommentList\n            hotList={data.hotComments}\n            showInput\n            list={commentList}\n            onCommentSubmit={this.onCommentSubmit}\n            commentCount={data.commentCount}\n          ></CommentList>\n        </View>\n      </View>\n    )\n  }\n}\n\nconst mapStateToProps = (state: IRootState) => ({\n  user: state.user\n})\n\nexport default connect<PropsFromState, PropsFromDispatch, PageOwnProps>(\n  mapStateToProps\n)(withShare({ title: '分享了你一条表白墙' })(ResourceDetail))\n","import { createPageConfig } from '@tarojs/runtime'\nimport component from \"../../../../../../node_modules/.pnpm/babel-loader@8.2.1_@babel+core@7.26.9_webpack@5.78.0_@swc+core@1.3.23_/node_modules/babel-loader/lib/index.js??ruleSet[1].rules[5].use[0]!./index.tsx\"\nvar config = {\"navigationBarTitleText\":\"资源分享详情\",\"enablePullDownRefresh\":true,\"backgroundTextStyle\":\"dark\",\"usingComponents\":{\"wemark\":\"../_components/wemark/wemark\"}};\ncomponent.enableShareTimeline = true\ncomponent.enableShareAppMessage = true\nvar inst = Page(createPageConfig(component, 'pages3/community/resource-detail/index', {root:{cn:[]}}, config || {}))\n\n\nexport default component\n"],"names":[],"sourceRoot":""}